<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Claiming Game</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pop': 'pop 0.3s ease-out',
                    },
                    keyframes: {
                        pop: {
                            '0%': { transform: 'scale(0.8)' },
                            '50%': { transform: 'scale(1.1)' },
                            '100%': { transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Flowbite -->
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css" rel="stylesheet" />
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Grid block hover effect */
        .block-cell {
            transition: all 0.15s ease;
        }
        .block-cell:hover {
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }
        
        /* Claimed animation */
        .just-claimed {
            animation: pop 0.3s ease-out;
        }
        
        /* Glassmorphism card */
        .glass-card {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Connection status pulse */
        .status-dot {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 min-h-screen">
    
    <div x-data="blockGame()" x-init="init()" class="container mx-auto px-4 py-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 bg-clip-text text-transparent mb-2">
                üéÆ Block Claiming Game
            </h1>
            <p class="text-gray-400 text-lg">Click blocks to claim your territory!</p>
        </header>
        
        <!-- Stats Bar -->
        <div class="glass-card rounded-2xl p-4 mb-6 flex flex-wrap items-center justify-between gap-4">
            
            <!-- Connection Status -->
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div :class="connected ? 'bg-green-500' : 'bg-red-500'" 
                         class="w-3 h-3 rounded-full status-dot"></div>
                    <div :class="connected ? 'bg-green-500' : 'bg-red-500'" 
                         class="w-3 h-3 rounded-full absolute top-0 left-0 animate-ping"></div>
                </div>
                <span class="text-gray-300 text-sm" x-text="connected ? 'Connected' : 'Connecting...'"></span>
            </div>
            
            <!-- User Info -->
            <div class="flex items-center gap-3">
                <div class="w-6 h-6 rounded-md shadow-lg" :style="`background-color: ${myColor}`"></div>
                <span class="text-gray-300 text-sm font-mono" x-text="myId"></span>
            </div>
            
            <!-- Stats -->
            <div class="flex gap-6">
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-400" x-text="myBlocks"></div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide">Your Blocks</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-pink-400" x-text="totalClaimed"></div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide">Total Claimed</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-cyan-400" x-text="gridSize * gridSize - totalClaimed"></div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide">Available</div>
                </div>
            </div>
        </div>
        
        <!-- Game Grid -->
        <div class="glass-card rounded-2xl p-6 overflow-auto">
            <div class="grid gap-1 mx-auto w-fit"
                 :style="`grid-template-columns: repeat(${gridSize}, minmax(0, 1fr))`">
                
                <template x-for="y in gridSize" :key="'row-' + y">
                    <template x-for="x in gridSize" :key="'cell-' + x + '-' + y">
                        <div @click="claimBlock(x-1, y-1)"
                             :class="[
                                 'block-cell w-6 h-6 md:w-7 md:h-7 rounded-sm cursor-pointer',
                                 getBlockOwner(x-1, y-1) ? '' : 'hover:bg-gray-600',
                                 justClaimed[`${x-1}-${y-1}`] ? 'just-claimed' : ''
                             ]"
                             :style="`background-color: ${getBlockColor(x-1, y-1)}`"
                             :title="getBlockTooltip(x-1, y-1)">
                        </div>
                    </template>
                </template>
                
            </div>
        </div>
        
        <!-- Toast Notifications -->
        <div class="fixed bottom-4 right-4 space-y-2 z-50">
            <template x-for="(toast, index) in toasts" :key="index">
                <div x-show="toast.show"
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 translate-x-8"
                     x-transition:enter-end="opacity-100 translate-x-0"
                     x-transition:leave="transition ease-in duration-200"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     :class="toast.type === 'error' ? 'bg-red-600' : 'bg-green-600'"
                     class="px-4 py-3 rounded-lg shadow-lg text-white text-sm flex items-center gap-2">
                    <svg x-show="toast.type === 'success'" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <svg x-show="toast.type === 'error'" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <span x-text="toast.message"></span>
                </div>
            </template>
        </div>
        
        <!-- Instructions -->
        <div class="mt-6 text-center text-gray-500 text-sm">
            <p>üñ±Ô∏è Click any gray block to claim it ‚Ä¢ üîÑ Updates are real-time across all players</p>
        </div>
        
    </div>
    
    <script>
        function blockGame() {
            return {
                // Grid configuration
                gridSize: 20,
                
                // WebSocket
                socket: null,
                connected: false,
                
                // User state
                myId: '',
                myColor: '#8B5CF6',
                
                // Block state: Map of "x-y" -> {owner, color}
                blocks: {},
                
                // Animation tracking
                justClaimed: {},
                
                // Toast notifications
                toasts: [],
                
                // Computed stats
                get myBlocks() {
                    return Object.values(this.blocks).filter(b => b.owner === this.myId).length;
                },
                get totalClaimed() {
                    return Object.keys(this.blocks).length;
                },
                
                init() {
                    this.connectWebSocket();
                },
                
                connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws/blocks/`;
                    
                    this.socket = new WebSocket(wsUrl);
                    
                    this.socket.onopen = () => {
                        this.connected = true;
                        this.showToast('Connected to game server!', 'success');
                    };
                    
                    this.socket.onclose = () => {
                        this.connected = false;
                        this.showToast('Disconnected. Reconnecting...', 'error');
                        // Reconnect after 2 seconds
                        setTimeout(() => this.connectWebSocket(), 2000);
                    };
                    
                    this.socket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                    
                    this.socket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleMessage(data);
                    };
                },
                
                handleMessage(data) {
                    switch (data.type) {
                        case 'init':
                            // Initialize user and blocks
                            this.myId = data.user_id;
                            this.myColor = data.color;
                            // Load existing blocks
                            data.blocks.forEach(block => {
                                this.blocks[`${block.x}-${block.y}`] = {
                                    owner: block.owner,
                                    color: block.color
                                };
                            });
                            break;
                            
                        case 'block_update':
                            // Update block state
                            this.blocks[`${data.x}-${data.y}`] = {
                                owner: data.owner,
                                color: data.color
                            };
                            // Trigger animation
                            this.justClaimed[`${data.x}-${data.y}`] = true;
                            setTimeout(() => {
                                this.justClaimed[`${data.x}-${data.y}`] = false;
                            }, 300);
                            break;
                            
                        case 'claim_rejected':
                            this.showToast('Block already claimed!', 'error');
                            break;
                            
                        case 'user_joined':
                            if (data.user_id !== this.myId) {
                                this.showToast(`${data.user_id} joined the game`, 'success');
                            }
                            break;
                            
                        case 'user_left':
                            this.showToast(`${data.user_id} left the game`, 'error');
                            break;
                    }
                },
                
                claimBlock(x, y) {
                    // Check if already claimed
                    if (this.blocks[`${x}-${y}`]) {
                        this.showToast('This block is already claimed!', 'error');
                        return;
                    }
                    
                    // Send claim request
                    if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                        this.socket.send(JSON.stringify({
                            type: 'claim',
                            x: x,
                            y: y
                        }));
                    }
                },
                
                getBlockOwner(x, y) {
                    const block = this.blocks[`${x}-${y}`];
                    return block ? block.owner : null;
                },
                
                getBlockColor(x, y) {
                    const block = this.blocks[`${x}-${y}`];
                    return block ? block.color : '#374151'; // gray-700 for unclaimed
                },
                
                getBlockTooltip(x, y) {
                    const block = this.blocks[`${x}-${y}`];
                    if (block) {
                        return block.owner === this.myId 
                            ? `Your block (${x}, ${y})` 
                            : `Owned by ${block.owner}`;
                    }
                    return `Click to claim (${x}, ${y})`;
                },
                
                showToast(message, type = 'success') {
                    const toast = { message, type, show: true };
                    this.toasts.push(toast);
                    
                    // Auto-hide after 3 seconds
                    setTimeout(() => {
                        toast.show = false;
                        // Remove from array after animation
                        setTimeout(() => {
                            const index = this.toasts.indexOf(toast);
                            if (index > -1) this.toasts.splice(index, 1);
                        }, 200);
                    }, 3000);
                }
            };
        }
    </script>
    
    <!-- Flowbite JS -->
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>
</body>
</html>
